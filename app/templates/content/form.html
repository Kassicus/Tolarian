{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('content.list') }}">Content</a></li>
<li class="breadcrumb-item active">{{ title }}</li>
{% endblock %}

{% block extra_css %}
<style>
    .editor-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        height: 500px;
    }
    .editor-pane, .preview-pane {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        overflow: auto;
    }
    .editor-pane textarea {
        width: 100%;
        height: 100%;
        border: none;
        padding: 1rem;
        font-family: 'Courier New', monospace;
        resize: none;
    }
    .preview-pane {
        padding: 1rem;
        background-color: #f8f9fa;
    }
    .preview-pane h1 { font-size: 2rem; }
    .preview-pane h2 { font-size: 1.5rem; }
    .preview-pane h3 { font-size: 1.25rem; }
    .preview-pane pre {
        background-color: #fff;
        border: 1px solid #dee2e6;
        padding: 0.5rem;
        overflow-x: auto;
    }
    /* Inline code styling */
    .preview-pane :not(pre) > code {
        background-color: #fff;
        padding: 0.125rem 0.25rem;
        color: #d63384;
    }
    /* Code blocks - let highlight.js handle colors */
    .preview-pane pre code {
        background-color: transparent;
        padding: 0;
        color: inherit;
        display: block;
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    }
    .preview-pane blockquote {
        border-left: 3px solid #0d6efd;
        padding-left: 1rem;
        margin-left: 0;
    }
    @media (max-width: 768px) {
        .editor-container {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h3><i class="bi bi-pencil-square"></i> {{ title }}</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="" id="contentForm">
                        {{ form.hidden_tag() }}

                        <div class="row mb-3">
                            <div class="col-md-8">
                                {{ form.title.label(class="form-label") }}
                                {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else "")) }}
                                {% if form.title.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.title.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                {{ form.slug.label(class="form-label") }}
                                {{ form.slug(class="form-control" + (" is-invalid" if form.slug.errors else "")) }}
                                <small class="text-muted">Auto-generated if left empty</small>
                                {% if form.slug.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.slug.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                {{ form.content_type.label(class="form-label") }}
                                {{ form.content_type(class="form-select" + (" is-invalid" if form.content_type.errors else ""),
                                                    onchange="toggleContentFields()") }}
                                {% if form.content_type.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.content_type.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                {{ form.category_id.label(class="form-label") }}
                                {{ form.category_id(class="form-select" + (" is-invalid" if form.category_id.errors else "")) }}
                                {% if form.category_id.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.category_id.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                {{ form.status.label(class="form-label") }}
                                {{ form.status(class="form-select" + (" is-invalid" if form.status.errors else "")) }}
                                {% if form.status.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.status.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- External URL field (for links only) -->
                        <div class="mb-3" id="externalUrlField" style="display: none;">
                            {{ form.external_url.label(class="form-label") }}
                            {{ form.external_url(class="form-control" + (" is-invalid" if form.external_url.errors else "")) }}
                            {% if form.external_url.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.external_url.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Markdown Editor -->
                        <div class="mb-3" id="contentBodyField">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                {{ form.body.label(class="form-label mb-0") }}
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="togglePreview()">
                                        <i class="bi bi-eye"></i> Toggle Preview
                                    </button>
                                    <a href="https://www.markdownguide.org/basic-syntax/" target="_blank"
                                       class="btn btn-sm btn-outline-info">
                                        <i class="bi bi-question-circle"></i> Markdown Help
                                    </a>
                                </div>
                            </div>

                            <!-- Markdown Toolbar -->
                            <div class="btn-toolbar mb-2" role="toolbar">
                                <div class="btn-group btn-group-sm me-2" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('**', '**')" title="Bold">
                                        <i class="bi bi-type-bold"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('*', '*')" title="Italic">
                                        <i class="bi bi-type-italic"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('~~', '~~')" title="Strikethrough">
                                        <i class="bi bi-type-strikethrough"></i>
                                    </button>
                                </div>
                                <div class="btn-group btn-group-sm me-2" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('# ', '')" title="Heading 1">
                                        H1
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('## ', '')" title="Heading 2">
                                        H2
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('### ', '')" title="Heading 3">
                                        H3
                                    </button>
                                </div>
                                <div class="btn-group btn-group-sm me-2" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('- ', '')" title="List">
                                        <i class="bi bi-list-ul"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('1. ', '')" title="Numbered List">
                                        <i class="bi bi-list-ol"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('> ', '')" title="Quote">
                                        <i class="bi bi-quote"></i>
                                    </button>
                                </div>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('`', '`')" title="Code">
                                        <i class="bi bi-code"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('```\n', '\n```')" title="Code Block">
                                        <i class="bi bi-code-square"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('[', '](url)')" title="Link">
                                        <i class="bi bi-link"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('![', '](url)')" title="Image">
                                        <i class="bi bi-image"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="editor-container" id="editorContainer">
                                <div class="editor-pane">
                                    {{ form.body(id="markdownEditor", onkeyup="updatePreview()", style="outline: none;") }}
                                </div>
                                <div class="preview-pane" id="previewPane">
                                    <div id="markdownPreview">Preview will appear here...</div>
                                </div>
                            </div>

                            {% if form.body.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.body.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Tags -->
                        <div class="mb-3">
                            {{ form.tags.label(class="form-label") }}
                            {{ form.tags(class="form-control" + (" is-invalid" if form.tags.errors else "")) }}
                            <small class="text-muted">Separate tags with commas</small>
                            {% if form.tags.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.tags.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Featured Checkbox -->
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.is_featured(class="form-check-input") }}
                                {{ form.is_featured.label(class="form-check-label") }}
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Save Content
                                </button>
                                <button type="submit" name="save_draft" value="1" class="btn btn-secondary">
                                    <i class="bi bi-file-earmark"></i> Save as Draft
                                </button>
                            </div>
                            <a href="{{ url_for('content.list') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// Toggle content fields based on content type
function toggleContentFields() {
    const contentType = document.getElementById('content_type').value;
    const bodyField = document.getElementById('contentBodyField');
    const urlField = document.getElementById('externalUrlField');

    if (contentType === 'link') {
        bodyField.style.display = 'none';
        urlField.style.display = 'block';
    } else {
        bodyField.style.display = 'block';
        urlField.style.display = 'none';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleContentFields();
    updatePreview();
});

// Update markdown preview
function updatePreview() {
    const markdown = document.getElementById('markdownEditor').value;
    const preview = document.getElementById('markdownPreview');

    if (markdown) {
        preview.innerHTML = marked.parse(markdown);

        // Apply syntax highlighting to code blocks
        if (typeof hljs !== 'undefined') {
            preview.querySelectorAll('pre code').forEach((block) => {
                // Normalize language classes
                if (block.className) {
                    const langMap = {
                        'language-python3': 'language-python',
                        'language-py': 'language-python',
                        'language-js': 'language-javascript',
                        'language-sh': 'language-bash',
                        'language-shell': 'language-bash',
                        'language-yml': 'language-yaml',
                        'language-c#': 'language-csharp',
                        'language-cs': 'language-csharp'
                    };

                    let classes = block.className.split(' ');
                    classes = classes.map(cls => langMap[cls] || cls);
                    block.className = classes.join(' ');
                }

                hljs.highlightElement(block);
            });
        }
    } else {
        preview.innerHTML = '<span class="text-muted">Preview will appear here...</span>';
    }
}

// Toggle preview visibility
let previewVisible = true;
function togglePreview() {
    const container = document.getElementById('editorContainer');
    previewVisible = !previewVisible;

    if (previewVisible) {
        container.style.gridTemplateColumns = '1fr 1fr';
    } else {
        container.style.gridTemplateColumns = '1fr';
    }

    document.getElementById('previewPane').style.display = previewVisible ? 'block' : 'none';
}

// Insert markdown formatting
function insertMarkdown(before, after) {
    const textarea = document.getElementById('markdownEditor');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selectedText = text.substring(start, end);

    const replacement = before + selectedText + after;
    textarea.value = text.substring(0, start) + replacement + text.substring(end);

    // Set cursor position
    const newCursorPos = start + before.length + selectedText.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();

    updatePreview();
}

// Handle save as draft
document.addEventListener('DOMContentLoaded', function() {
    const draftButton = document.querySelector('button[name="save_draft"]');
    if (draftButton) {
        draftButton.addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('status').value = 'draft';
            document.getElementById('contentForm').submit();
        });
    }
});
</script>
{% endblock %}